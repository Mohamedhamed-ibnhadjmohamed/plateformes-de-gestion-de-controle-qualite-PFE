<div class="container section mt-2" >

    <div class="d-flex justify-content-between">
        <!-- Qte mineure -->
        <div class="fs-4 mb-3 px-3 fw-bolder">
            <i class="fas fa-lightbulb" [ngClass]="{
           'text-success': mineur < donnee[0]?.qte_mineure,  
           'text-warning': mineur === donnee[0]?.qte_mineure,
           'text-danger': mineur > donnee[0]?.qte_mineure 
         }"></i>
            {{ mineur }} / {{ donnee[0]?.qte_mineure }} : mineure
        </div>

        <!-- Qte majeure -->
        <div class="fs-4 mb-3 px-3 fw-bolder">
            <i class="fas fa-lightbulb" [ngClass]="{
           'text-success': majeur < donnee[0]?.qte_majeure,  
           'text-warning': majeur === donnee[0]?.qte_majeure,
           'text-danger': majeur > donnee[0]?.qte_majeure 
         }"></i>
            {{ majeur }} / {{ donnee[0]?.qte_majeure }} : majeure
        </div>

        <!-- Qte critique -->
        <div class="fs-4 mb-3 px-3 fw-bolder">
            <i class="fas fa-lightbulb" [ngClass]="{
           'text-success': critique < donnee[0]?.qte_critique,  
           'text-warning': critique === donnee[0]?.qte_critique,
           'text-danger': critique > donnee[0]?.qte_critique 
         }"></i>
            {{ critique }} / {{ donnee[0]?.qte_critique }} : critique
        </div>
    </div>

</div>


<!--------------------- liste des defauts -->
<div class="table-responsive">
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#AjouterModal"
            [disabled]="isButtonDisabled">
            <i class="fa-solid fa-plus ms-2 "></i> Ajouter un defaut
        </button>
    </div>
    <div *ngIf="defaults && defaults.length > 0; else noData">
        <h3 class="mb-0  ">
            <h1 class="title">
                <span class="highlight"><i class="fas fa-box"></i>
                    Liste des defauts
                </span>
            </h1>
        </h3>
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Description</th>
                    <th scope="col">Image</th>
                    <th scope="col">Type</th>
                    <th scope="col">Nombre</th>
                    <th scope="col" [width]="150">Options</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let default of defaults">
                    <td>{{ default.description }}</td>
                    <td>
                        <img *ngIf="default.image"
                            [src]="'http://localhost:3000/upload/' + extraireNomFichier(default.image)" alt="img"
                            class="img-thumbnail" width="100">
                    </td>
                    <td>{{ default.type }}</td>
                    <td>{{default.nombre}}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-dark" data-bs-toggle="modal"
                                data-bs-target="#ConsulterModal" (click)="confirmer(default)">
                                <i class="fas fa-eye"></i> Consulter
                            </button>

                            <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                data-bs-target="#SupprimerModal" (click)="confirmer(default)">
                                <i class="fas fa-trash-alt"></i> Supprimer
                            </button>
                        </div>

                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<ng-template #noData>
    <p class="text-center py-3 btn-success">Aucun défaut pour le moment à afficher. Remplissez le formulaire pour
        ajouter un nouveau défaut.
    </p>
</ng-template>

<!-- Modal Consulter -->
<div class="modal fade modal-xl" id="ConsulterModal" tabindex="-1" aria-labelledby="ConsulterModal Label"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="ConsulterModal Label">Consulter {{name}}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container mt-5">
                    <div class="row">
                        <div class="col">

                            <div class="card-body d-flex">
                                <div class="flex-grow-1 text-start">
                                    <p class="card-text"><strong>Identifiant Défault :</strong> {{ default.id_defaults
                                        }}
                                    </p>
                                    <p class="card-text"><strong>Description du défaut :</strong> {{ default.description
                                        }}
                                    </p>

                                    <p class="card-text"><strong>Famille globale du défaut :</strong>
                                        <span *ngFor="let familledefault of familledefaults">
                                            <span *ngIf="familledefault.id_famille == default.id_famille">
                                                {{ familledefault.nom }}
                                            </span>
                                        </span>
                                    </p>

                                    <p class="card-text"><strong>nombre d'inspection :</strong> {{ default.id_inspection
                                        }}
                                    </p>
                                    <p class="card-text"><strong>Nombre de pièces du même défaut :</strong> {{
                                        default.nombre }}</p>

                                    <p class="card-text"><strong>Type de défaut</strong> {{ default.type }}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <strong>Image du défaut :</strong>
                                    <br>
                                    <img *ngIf="default.image" style="width: 400px; height: 200px;"
                                        [src]="'http://localhost:3000/upload/' + extraireNomFichier(default.image)"
                                        alt="Image du défaut">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Fin Modal Consulter -->

<!-- Modal Ajouter -->
<div class="modal fade modal-xl" id="AjouterModal" tabindex="-1" aria-labelledby="AjouterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="AjouterModalLabel">Ajouter {{name}}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form [formGroup]="defaultForm" (ngSubmit)="ajoutDefault()">
                    <div class="form-group">
                        <label for="description">Description du défaut :</label>
                        <input type="text" class="form-control" id="description" formControlName="description"
                            placeholder="Description">
                        <div *ngIf="description?.invalid && description?.dirty && description?.touched"
                            class="text-danger">
                            <small *ngIf="description?.errors?.['required']">La description est requise.</small>
                            <small *ngIf="description?.errors?.['maxlength']">La description ne peut pas dépasser 255
                                caractères.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="image">Image :</label>
                        <input type="file" class="form-control" (change)="onFileSelected($event)" id="image"
                            formControlName="image">
                    </div>

                    <div *ngIf="imagePreview">
                        <img [src]="imagePreview" alt="Image preview"
                            style="width: 200px; height: 200px; margin-top: 10px;">
                    </div>


                    <div class="form-group">
                        <label for="id_famille">Famille globale du défaut :</label>
                        <select class="form-control" id="id_famille" formControlName="id_famille">
                            <option *ngFor="let familledefault of familledefaults" [value]="familledefault.id_famille">
                                {{familledefault.nom}}
                            </option>
                        </select>
                        <div *ngIf="id_famille?.invalid && id_famille?.touched" class="text-danger">
                            <small *ngIf="id_famille?.errors?.['required']">La famille est requise.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="nombre">Nombre de pièces du même défaut :</label>
                        <input type="number" class="form-control" id="nombre" formControlName="nombre">
                        <div *ngIf="nombre?.invalid && nombre?.touched" class="text-danger">
                            <small *ngIf="nombre?.errors?.['required']">Le nombre est requis.</small>
                            <small *ngIf="nombre?.errors?.['min']">Le nombre doit être supérieur ou égal à 1.</small>
                            <small *ngIf="nombre?.errors?.['max']">Le nombre ne peut pas dépasser 5.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="type">Type de défaut :</label>
                        <select class="form-control" id="type" formControlName="type">
                            <option value="mineur">Mineur</option>
                            <option value="majeur">Majeur</option>
                            <option value="critique">Critique</option>
                        </select>
                        <div *ngIf="type?.invalid && type?.touched" class="text-danger">
                            <small *ngIf="type?.errors?.['required']">Le type est requis.</small>
                        </div>
                    </div>



                    <button type="reset" class="btn btn-danger" (click)="resetForm()">Annuler</button>
                    <button type="submit" class="btn btn-primary" [disabled]="!defaultForm.valid"
                        data-bs-dismiss="modal">Ajouter un nouveau défaut</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Fin Modal Ajouter -->

<!-- Modal Modifier -->
<div class="modal fade modal-xl" id="ModifierModal" tabindex="-1" aria-labelledby="ModifierModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="ModifierModalLabel">Modifier {{name}}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" *ngIf="default">
                <form [formGroup]="defaultForm" (ngSubmit)="modifierDefault()">
                    <div class="form-group">
                        <label for="description">Description :</label>
                        <input type="text" class="form-control" id="description" formControlName="description"
                            placeholder="Description" [value]="default.description">
                        <div *ngIf="description?.invalid && description?.touched" class="text-danger">
                            <small *ngIf="description?.errors?.['required']">La description est requise.</small>
                            <small *ngIf="description?.errors?.['maxLength']">La description ne peut pas dépasser 255
                                caractères.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="image">Image :</label>
                        <input type="file" class="form-control" (change)="onFileSelected($event)" id="image"
                            formControlName="image">
                    </div>

                    <div *ngIf="imagePreview">
                        <img [src]="imagePreview" alt="Image preview" style="max-width: 200px; margin-top: 10px;">
                    </div>


                    <div class="form-group">
                        <label for="id_famille">Famille default :</label>
                        <select class="form-select" id="id_famille" formControlName="id_famille">
                            <option disabled>
                                <span *ngFor="let familledefault of familledefaults">
                                    <span *ngIf="familledefault.id_famille == default.id_famille">
                                        chonger : {{ familledefault.nom }}
                                    </span>
                                </span>
                            </option>
                            <option *ngFor="let familledefault of familledefaults" [value]="familledefault.id_famille">
                                {{familledefault.nom}}
                            </option>
                        </select>
                        <div *ngIf="id_famille?.invalid && id_famille?.touched" class="text-danger">
                            <small *ngIf="id_famille?.errors?.['required']">L'ID famille est requis.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="nombre">Nombre :</label>
                        <input type="number" class="form-control" id="nombre" [value]="default.nombre"
                            formControlName="nombre">
                        <div *ngIf="nombre?.invalid && nombre?.touched" class="text-danger">
                            <small *ngIf="nombre?.errors?.['required']">Le nombre est requis.</small>
                            <small *ngIf="nombre?.errors?.['min']">Le nombre doit être supérieur ou égal à 1.</small>
                            <small *ngIf="nombre?.errors?.['max']">Le nombre ne peut pas dépasser 100.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="type">Type :</label>
                        <select class="form-select" id="type" formControlName="type">
                            <option disabled>Chonger : {{default.type}}</option>
                            <option value="mineur">Mineur</option>
                            <option value="majeur">Majeur</option>
                            <option value="critique">Critique</option>
                        </select>
                    </div>



                    <button type="submit" class="btn btn-primary" data-bs-dismiss="modal"
                        [disabled]="!defaultForm.valid">Modifier</button>
                    <button type="reset" class="btn btn-danger" data-bs-dismiss="modal">Annuler</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Fin Modal Modifier -->

<!-- Modal Supprimer -->
<div class="modal fade" id="SupprimerModal" tabindex="-1" aria-labelledby="SupprimerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" *ngIf="default">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="SupprimerModalLabel">Supprimer {{ name }}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container mt-5">
                    <div class="row">
                        <div class="col">
                            <div class="alert alert-danger" role="alert">
                                Êtes-vous sûr de vouloir supprimer l'élément "<strong>{{ name }}</strong>" ?
                            </div>
                            <div class="card-body d-flex">
                                <div class="flex-grow-1 text-start">
                                    <p class="card-text"><strong>Identifiant Défault :</strong> {{ default.id_defaults
                                        }}
                                    </p>
                                    <p class="card-text"><strong>Description du défaut :</strong> {{ default.description
                                        }}
                                    </p>

                                    <p class="card-text"><strong>Famille globale du défaut :</strong>
                                        <span *ngFor="let familledefault of familledefaults">
                                            <span *ngIf="familledefault.id_famille == default.id_famille">
                                                {{ familledefault.nom }}
                                            </span>
                                        </span>
                                    </p>

                                    <p class="card-text"><strong>nombre d'inspection :</strong> {{ default.id_inspection
                                        }}
                                    </p>
                                    <p class="card-text"><strong>Nombre de pièces du même défaut :</strong> {{
                                        default.nombre }}</p>
                                    <p class="card-text"><strong>Type de défaut</strong> {{ default.type }}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <strong>Image du défaut :</strong>
                                    <br>
                                    <img *ngIf="default.image" style="width: 400px; height: 200px;"
                                        [src]="'http://localhost:3000/upload/' + extraireNomFichier(default.image)"
                                        alt="Image du défaut">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" (click)="supprimer(default)" data-bs-dismiss="modal">
                    <i class="fas fa-trash-alt"></i> Supprimer
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Fin Modal Supprimer -->